# System Design — AI аналитика PAM-сессий — Анализ

## 1. Контекст и входные данные

### 1.1 Что есть в PAM (фактически)
- **SSH:** журналы хранятся в **SQL БД** в формате JSON-сегментов:
  - исходящие: `{seq,size,stdOut,direction}`
  - входящие: `{seq,size,stdIn,direction}`
- **RDP/VNC:** скриншоты и видео хранятся **локально на сервисе** (в будущем планируется миграция в S3/объектное хранилище).
- В PAM есть понятия: **сессии (активные/история), политики, reason/approval**, аудит, и возможность **оперативно прервать активную сессию** (ручное действие).

### 1.2 Принципиальные ограничения
- AI-модуль не должен ломать основной контур доступа (sidecar / out-of-band).
- Для RDP анализ "по видео в реальном времени” — дорого; основной путь — **micro-batch по скриншотам** + дедуп + выборочные тяжёлые модели.

---

## 2. Цели

### 2.1 Цели (высокий приоритет)
1) **Проактивная (near-real-time) аналитика SSH**:
   - реконструкция команд из stdin потока
   - оценка риска/намерения (intent)
   - детект опасных последовательностей
   - алерты в SOC/SIEM, итоговая сводка
2) **Micro-batch аналитика RDP/VNC**:
   - обработка скриншотов по поступлению
   - YOLO как фильтр
   - OCR/мультимодал (Gemma) — только для "интересных” кадров
3) **UEBA-lite** (поведенческие отклонения) на метаданных и агрегатах.

### 2.2 Не является целями MVP
- Автоматическое "kill session” по решению AI (только через оператора).
- Полноценная видеоаналитика 25–30 FPS.
- Дообучение YOLO на кастомном датасете.

---

## 3. AI-сценарии (каталог)

| Категория   | Сценарий | Данные | Выход | Этап |
|-------------|---|---|---|---|
| Аудит       | Авто-сводка сессии | SSH поток / RDP кадры | summary + таймлайн | MVP |
| SOC-2 аудит | Risk scoring сессии | команды/кадры + метаданные | score + теги | MVP |
| Поиск       | Семантический поиск по сессиям | OCR (редакт.) + команды + summary | поиск "где было …” | Pilot |
| JIT ассистент         | Ассистент согласования | reason + профиль + история | "типично/нетипично” | Pilot |
| UEBA анализ поведения       | Отклонения поведения | частоты, окна, ресурсы, intents | алерт "аномалия” | Pilot |
| Hard Computer Vision     | UI-детекция действий | скриншоты | "что делал в GUI” | Позже |

---

## 4. OCR для RDP — оценка реализуемости

### 4.1 Реалистичная стратегия
- OCR **не по видео**, а по **скриншотам**.
- Перед OCR: **дедуп/дельта**, обработка только значимых кадров.
- Результат OCR сохранять **с редактированием**, либо хранить только хеши/векторные признаки.

### 4.2 Риски OCR
- мелкий шрифт, компрессия RDP, артефакты;
- RU/EN, спецсимволы, пути, GUID;
- риск извлечения секретов (пароли/ключи) - соответственно обязательно пост-редактирование для маскирования секретов.

**Вывод:** OCR подходит для **индексации/поиска/сигналов риска**, но не как "идеальная расшифровка”.

---

## 5. NLP/LLM анализ SSH — оценка реализуемости

### 5.1 Почему SSH — лучший кандидат для проактивного мониторинга
- данные уже текстовые (stdin/stdout);
- можно tail-ить почти как стрим;
- дешёвые вычисления, высокая точность.

### 5.2 Ключевая инженерная задача
Из JSON-сегментов в БД нужно восстановить:
- поток терминала
- командные события

Примерный алгоритм:
- буферизовать `stdIn` до `\r`/`\n`
- учитывать backspace (`\b`, `\x7f`)
- выделять интерактивные режимы (vim/htop) и снижать степень NLP-анализа.

---

## 6. Модели заказчика и их роль

| Модель | Тип | Роль в системе | Основные риски |
|---|---|---|---|
| Gemma | мультимодал | семантика RDP кадров, помощь OCR | стоимость, качество на мелком тексте |
| T-Pro 2.1 | текст | отчёты/summary, reason-анализ | форматирование/строгость вывода |
| OSS от OpenAI | текст | универсальная LLM (summary/теги/поиск) | валидация, "галлюцинации” |
| Qwen Coder | текст/код | разбор shell/скриптов, намерение команд | требует строгих промптов и JSON |
| Whisper | аудио | только если есть аудио-источник | может быть не применимо |
| YOLO 11 | CV | быстрый фильтр кадров/объектов | без дообучения — ограниченная точность |

---

## 7. Методы выявления отклонений (UEBA-lite)

### 7.1 Быстро (MVP/Pilot)
- Baseline по пользователю/роли:
  - время суток, частота сессий, топ-ресурсы
  - распределение intents
- Методы: пороги, z-score, EWMA, "новизна” (new resource/IP)

### 7.2 Среднесрок
- Использование алгоритма Isolation Forest:
  - доля risky команд
  - редкие последовательности
  - "скачки” времени/ресурсов

### 7.3 Долгосрок
- последовательные модели (Transformer encoder) для цепочек команд.

---

## 8. SLO/SLA (черновик)

> SLA — внешнее обязательство, SLO — целевые метрики внутри команды.  
> Ниже — "лимитированный прод”, т.к. в прототипе/ОПЭ SLA обычно нет.

| Компонент/метрика | SLO (лим. прод) | SLA (лим. прод) | Примечание |
|---|---:|---:|---|
| Доступность AI аналитики | 99.5% | 99.0% | при падении AI — PAM работает (fail-open) |
| Задержка SSH алерта P95 | ≤ 10 сек | ≤ 30 сек | от ввода команды до алерта |
| Задержка RDP алерта P95 | ≤ 30 сек | ≤ 90 сек | от появления скрина до алерта |
| Потеря событий | 0 (best effort) | ≤ 0.1% | обеспечивается очередью + идемпотентностью |
| RPO (Results DB) | ≤ 5 мин | ≤ 15 мин | репликация + бэкапы |
| RTO | ≤ 30 мин | ≤ 2 часа | зависит от инфраструктуры |
| Время доставки алерта в SIEM | ≤ 5 сек | ≤ 30 сек | после формирования алерта |

---

## 9. Модель угроз

| STRIDE | Угроза | Вектор | Риск | Контрмеры (минимум) |
|---|---|---|---|---|
| S (Spoofing) | Подмена источника событий | фейковые сегменты/файлы | Высокий | подпись событий/внутр. auth, allowlist источников, mTLS |
| T (Tampering) | Подмена артефактов | изменение скринов/логов | Высокий | WORM/immutability, хеш-цепочка, права только read |
| R (Repudiation) | Отказ от действий | спор "кто делал” | Средний | связка session_id+policy+user_id, неизменяемые журналы |
| I (Info Disclosure) | Утечка секретов | OCR/логи содержат пароли | Критичный | redaction, шифрование, RBAC, ретеншн, аудит доступа |
| D (DoS) | Перегруз аналитики | всплеск скринов/команд | Средний | backpressure, лимиты, деградация (только YOLO/правила) |
| E (Elevation) | Повышение привилегий в AI | доступ к БД/FS шире нужного | Высокий | least privilege, separate accounts, network policies |

---

## 10. Параметры плановой нагрузки (для примерного расчета нагрузки)
> Эти параметры можно заменить на фактические после пилота.

- Старт "лимитированного прода”: **100 одновременных сессий** (70 SSH / 30 RDP)
- Средняя длительность: **20 минут**
- Интервал скриншотов: **2 секунды**
- Дедуп уникальных кадров: **30%**
- Доля кадров для Gemma: **5%**
- SSH командная активность: **1 команда / 10 секунд / активную SSH-сессию**

Из этого получается (месяц 0):
- RDP сырьё (скриншоты): ~15.0/сек
- RDP на анализ (после dedup): ~4.5 кадров/сек
- Gemma: ~0.225 кадров/сек
- SSH команды: ~7.0 команд/сек

---

## 11. Оценка хранения (AI-артефакты)

Предположения (настройки AI, не PAM):
- Сохраняем **только доказательства** (thumbnail/ROI), а не все скриншоты.
- Средний размер thumbnail: **150 KB**
- Среднее кол-во "флагнутых” кадров на RDP-сессию: **10**

Оценка объёма:
- Месяц 0: ~3.09 GB/день (≈ 92.7 GB за 30 дней)
- Месяц 12 (x14.55): ~45.0 GB/день (≈ 1.32 TB за 30 дней)

---

## 12. Выводы (кратко)
- **SSH**: наиболее окупаемый proactive слой, реализуем через DB tailing по `seq`.
- **RDP**: основной путь — микропакеты по скриншотам + дедуп + YOLO; Gemma выборочно.
- **UEBA-lite**: быстро и полезно как "второй слой” детекта.
- Для 12-месячного роста 25%/мес ключ — **ограничивать долю тяжёлых моделей** и масштабировать worker/GPU по метрикам.

